<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

   <!--  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet"> -->

    <title>d-Market</title>
    <style>
    	 body {
            /*font-family: 'Special Elite', monaco, monospace;*/
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
            font-size: 104%;
            background-color: #222;
            color: #fff;
        }
        .modal-content {
            color: #222;
        }
        .h1, h1 {
            font-size: 2.75rem;
            text-align: center;
            padding: 1rem 0;
        }
        h2 {
            text-align: center;
        }
        h4 {
            text-align: center;
            padding: 0 0 2rem 0;
        }
    	.row {
    		padding-bottom: 15px;
    	}
        a {
            color: #3c87c7;
        }
        a:hover {
            text-decoration: none;
        }
        .table {
            color: white;
        }
        .description {
            margin-top: 1em;
            font-size: 0.9em;
            overflow: hidden;
        }
        .quantity, .price {
            font-size: 0.9em;
            overflow: hidden;
            margin: 0;
        }
        #goodQR img {
            width: 100%;
        }
        img {
            width: 95%;
        }
        .imgContainer {
            height: 350px;
            overflow: hidden;
        }
    </style>
  </head>
  <body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
          <a class="navbar-brand" href="/">d-Market</a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav mr-auto">
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      Top Categories
                    </a>
                    <div id="dropdownList" class="dropdown-menu" aria-labelledby="navbarDropdown">
                    </div>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="#" data-toggle="modal" data-target="#aboutModal">About</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="loginButton" href="#" data-toggle="modal" data-target="#loginModal">Login</a>
                  </li>
              </ul>

              <form class="form-inline" action="/">
                <input class="form-control mr-sm-2" type="search" id="search" name="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
              </form>
          </div>
        </div>
    </nav>
  	<div id="container" class="container pt-2">
        Loading...
  	</div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Login</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <label for="loginAccount">Account Address</label>
                <input type="text" class="form-control" id="loginAccount" placeholder="ARDOR-XXXX-XXXX-XXXX-XXXXX">
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" id="login" class="btn btn-primary" onclick="login()">Login</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Modal -->
    <div class="modal fade" id="accountModal" tabindex="-1" role="dialog" aria-labelledby="accountModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="accountModalLabel">Account</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <label for="marketAccount">Account Address</label>
                <input type="text" readonly="" class="form-control" id="marketAccount" placeholder="ARDOR-XXXX-XXXX-XXXX-XXXXX">
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" id="logout" class="btn btn-primary" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aboutModalLabel">About</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>d-Market is a portal to the Decentralized Marketplace on Ardor.  When purchasing it will generate a QR code to be signed with the Ardor Lite App or SIGRO app(Coming Soon)</p>
            <p>It also provides an escrow service for a 5 IGNIS fee. Funds will be sent to an escrow account and then forwarded with a pending phased transaction to the seller requiring the buyer to approve once they have the good.  If there is an issue, the buyer has 14 days to notify the escrow account to lock the funds or else they are released to the seller.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Buy Modal -->
    <div class="modal fade" id="buyModal" tabindex="-1" role="dialog" aria-labelledby="buyModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="buyModalLabel">Buy <span id="goodID"></span></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="paymentInfo">
              <div class="form-group">
                <label for="sendAccount">Sending Account Address</label>
                <input type="text" class="form-control" id="sendAccount" placeholder="ARDOR-XXXX-XXXX-XXXX-XXXXX">
              </div>
              <div class="form-group">
                <label for="buyingInfo">Any necessary information</label>
                <input type="text" class="form-control" id="buyingInfo" placeholder="Size, color, etc.">
              </div>
              <div class="form-check">
                  <input class="form-check-input" type="checkbox" checked value="escrow" id="escrowBox">
                  <label class="form-check-label" for="escrowBox">
                    Buyer Protection (<a href="#" data-toggle="tooltip" data-placement="top" data-html="true" title="Funds will be sent to an escrow account and then forwarded with a pending phased transaction to the seller requiring the buyer to approve once they have the good.  If there is an issue, the buyer has 14 days to notify the escrow account to lock the funds or else they are released to the seller.">?</a>)
                  </label>
                </div>
              Price: <span id="goodPrice"></span><br />
              Fees: <span id="goodFee"></span><br />
              Total: <span id="goodTotal"></span><br />
                <button type="button" id="generatePayment" class="btn btn-secondary">Generate Payment</button><br />
            </div>

            <div id="scanInfo">
                Scan this QR code with <a href="https://squirrelsystems.net/ardor/" target="_blank">Ardor Lite</a> or SIGBRO(Coming Soon)
            </div>
            <div id="goodQR"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Buy</button> -->
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script>
        let goodPrice, goodFee, goodID;
        function getTransaction( goodID, goodTotalPrice ) {
            let sendAccount = document.getElementById("sendAccount").value;
            if (sendAccount.length > 20 && sendAccount.length < 28) {
                let buyingInfo = document.getElementById("buyingInfo").value;
                let node_number=Math.floor((Math.random() * 8) + 1);
                node_number = 7;
                
                let pKeyUrl = "https://testnode"+node_number+".ardor.tools/nxt?requestType=getAccount&account="+sendAccount;
                $.getJSON(pKeyUrl, function(result){
                    if (result['publicKey']) {
                        let url, jqxhr;
                        if ($("#escrowBox").is(':checked')) {
                            url = "https://testnode"+node_number+".ardor.tools/nxt?requestType=sendMoney";
                            jqxhr = $.post( url, { chain: 2, deadline: 30, amountNQT: goodTotalPrice, messageIsPrunable: true, message: '{ "contract": "Escrow", "params": { "goods": "'+goodID+'", "buyerMsg": "'+buyingInfo+'" }}', recipient: "ARDOR-64L4-C4H9-Z9PU-9YKDT", publicKey: result['publicKey'] })
                        } else {
                            let deliveryDeadlineTime = Math.trunc(new Date().getTime()/1000 - new Date("2017-12-26T14:00:00Z").getTime()/1000 + 345600);
                            url = "https://testnode"+node_number+".ardor.tools/nxt?requestType=dgsPurchase";
                            jqxhr = $.post( url, { chain: 2, deadline: 30, priceNQT: goodTotalPrice, messageIsPrunable: true, message: '{ "buyerMessage": "'+buyingInfo+'" }', goods: goodID, quantity: "1", deliveryDeadlineTimestamp: deliveryDeadlineTime, publicKey: result['publicKey'] })
                        }

                        //var jqxhr = $.post( url, { chain: 2, priceNQT: goodTotalPrice, goods: goodID, quantity: 1, publicKey: result['publicKey'] })
                        jqxhr.done(function( results ) {
                            $('#paymentInfo').hide();
                            $('#scanInfo').show();
                            let resultJson = JSON.parse(results);
                            document.getElementById("goodQR").innerHTML = "<img src='https://chart.googleapis.com/chart?chs=400x400&cht=qr&chl="+resultJson['unsignedTransactionBytes']+"||"+JSON.stringify(resultJson['transactionJSON']['attachment'])+"&choe=UTF-8&chld=Q' title='Payment' />";
                            // document.getElementById("sigbroQR").innerHTML = "<img src='https://chart.googleapis.com/chart?chs=400x400&cht=qr&chl="+resultJson['unsignedTransactionBytes']+"||"+JSON.stringify(resultJson['transactionJSON']['attachment'])+"&choe=UTF-8&chld=Q' title='Payment' />";
                          })
                          .fail(function() {
                            alert( "error" );
                          })
                          .always(function() {
                            console.log( "finished" );
                          });

                      } else {
                        alert("Could not get the account's Public Key.  Please verify it")
                      }
                  });
              } else {
                alert("Invalid Address");
              }

        }

        function login () {
            let loginAccount = document.getElementById("loginAccount").value;
            if (loginAccount.length > 20 && loginAccount.length < 28) {
                localStorage.setItem("dMarket_account", loginAccount);
                location.reload();
            } else {
                alert("Invalid Address");
            }
        }

        function logout () {
            localStorage.removeItem("dMarket_account");
            location.reload();
        }

        $("#escrowBox").change(function () {
            if ($(this).is(':checked')) {//this is true if the switch is on
                goodFee = 500000000
                setPrice();
            }
            else {
                goodFee = 0
                setPrice();
            }
        });

        $('#buyModal').on('show.bs.modal', function(e) { 
            $('#paymentInfo').show();
            $('#scanInfo').hide();
            document.getElementById("buyingInfo").value = "";
            document.getElementById("goodQR").innerHTML = "";

            goodPrice = $(e.relatedTarget).data('good-price');
            if (goodPrice > 500000000) {
                $("#escrowBox").prop( "checked", true );
                goodFee = 500000000;
            } else {
                $("#escrowBox").prop( "checked", false );
                goodFee = 0;
            }

            
            $(e.currentTarget).find('#goodPrice').text(goodPrice/100000000);

            let goodTitle = $(e.relatedTarget).data('good-title');
            $(e.currentTarget).find('#goodID').text(goodTitle);

            goodID = $(e.relatedTarget).data('good-id');
            setPrice();
            
        });

        function setPrice(){
            $('#buyModal').find('#goodFee').text(goodFee/100000000);
            $('#buyModal').find('#goodTotal').text((goodPrice+goodFee)/100000000);
            $('#generatePayment').removeAttr('onclick');
            $('#generatePayment').attr('onClick', 'getTransaction("'+goodID+'", "'+(goodPrice+goodFee)+'");');
        }

        $(function () {
          $('[data-toggle="tooltip"]').tooltip()

          if (localStorage.getItem("dMarket_account")) {
            document.getElementById("loginButton").innerHTML = localStorage.getItem("dMarket_account");
            $('#loginButton').attr("data-target", "#accountModal");
            $('#marketAccount').val(localStorage.getItem("dMarket_account"));
            $('#sendAccount').val(localStorage.getItem("dMarket_account"));
          }

          let node_number=Math.floor((Math.random() * 8) + 1);
          node_number = 7;

          let url = "https://testnode"+node_number+".ardor.tools/nxt?requestType=getDGSGoods&chain=2&inStockOnly=true&hideDelisted=true";
          const urlParams = new URLSearchParams(window.location.search);
          const myParam = urlParams.get('search');

          if (myParam) {
            url = "https://testnode"+node_number+".ardor.tools/nxt?requestType=searchDGSGoods&chain=2&inStockOnly=true&hideDelisted=true&query="+myParam;
            document.getElementById("search").value = myParam;
          }

          let items_table = "<div class='row'>";

          $.getJSON(url, function(result){
                $.each(result['goods'], function(i, field){
                    //console.log(field);
                    items_table += "<div class='col-sm-4'>";

                    if (field['hasImage']) {
                        items_table += "<div class='imgContainer'><img src='https://testnode"+node_number+".ardor.tools/nxt?requestType=downloadPrunableMessage&&chain=IGNIS&transactionFullHash="+field['goodsFullHash']+"&retrieve=true' /></div>";
                    } else {
                        items_table += "<div class='imgContainer'><img src='https://www.freeiconspng.com/uploads/no-image-icon-15.png' /></div>";
                    }

                    items_table += "<h4>"+field['name']+"</h4>";
                    items_table += "<p class='description'>"+field['description']+"</p>";
                    items_table += "<p class='quantity'>Quantity: "+field['quantity']+"</p>";
                    items_table += "<p class='priceNQT'>Price: "+field['priceNQT']/100000000+"</p>";
                    items_table += '<button type="button" class="btn btn-primary" data-good-title="'+field['name']+'" data-good-price="'+field['priceNQT']+'" data-good-id="'+field['goods']+'" data-toggle="modal" data-target="#buyModal">Buy</button>';
                    items_table += "</div>";
                    if (i!= 0 && (i+1) % 3 === 0) {
                        items_table += "</div><div class='row'>";
                    }
                });
                items_table += "</div>";
                let element = document.getElementById("container");
                element.innerHTML = items_table;
            });
          let tagsUrl = "https://testnode"+node_number+".ardor.tools/nxt?requestType=getDGSTags&chain=2&inStockOnly=true&lastIndex=10"
          $.getJSON(tagsUrl, function(result){
                let listItems = "";
                $.each(result['tags'], function(i, field){
                    listItems += '<a class="dropdown-item" href="https://dnet.market/?search='+field['tag']+'">'+field['tag']+'<a>';
                });

                let dropdownList = document.getElementById("dropdownList");
                dropdownList.innerHTML = listItems;
            });

        })
        
    </script>
  </body>
  </html>